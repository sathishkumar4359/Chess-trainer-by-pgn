<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChessReps Pro | V2.5 Final</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        :root { --bg: #121212; --panel: #262421; --accent: #81b64c; --text: #bababa; --border: #312e2b; --danger: #fa412d; --blue: #4583b6; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; background: #1e1e1e; border-bottom: 2px solid var(--border); }
        .header-btns { display: flex; gap: 8px; align-items: center; width: 100%; justify-content: space-between; }
        
        #board-wrapper { width: 92vw; max-width: 360px; aspect-ratio: 1/1; margin: 10px auto; border: 1px solid var(--border); }
        
        .white-1e1d7 { background-color: #ebecd0 !important; }
        .black-3c85d { background-color: #779556 !important; }
        
        /* THE FIX: Use background colors for dots and selection to avoid DOM issues */
        .selected-square { background-color: rgba(255, 255, 0, 0.6) !important; }
        .hint-square { box-shadow: inset 0 0 10px 5px rgba(255, 255, 0, 0.8) !important; }
        
        /* Visual dot for legal moves */
        .legal-dot {
            height: 20px; width: 20px; background: rgba(0, 0, 0, 0.2);
            border-radius: 50%; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 10;
        }

        .controls { width: 92vw; max-width: 360px; margin: 0 auto 10px; background: var(--panel); padding: 12px; border-radius: 8px; box-sizing: border-box; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        button { padding: 12px 2px; border-radius: 6px; font-weight: bold; border: none; color: #fff; cursor: pointer; text-transform: uppercase; font-size: 0.65rem; }
        
        .library-section { flex: 1; overflow-y: auto; background: #1a1917; }
        .repo-item { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .repo-item.active { background: #2b2926; border-left: 4px solid var(--accent); }
        .item-name { font-weight: bold; font-size: 0.85rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }
        
        .item-actions { display: flex; gap: 12px; }
        .action-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 1rem; padding: 5px; }
        .nav-btn { font-size: 0.65rem; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; border: none; color: white; min-width: 80px; text-align: center; }
    </style>
</head>
<body>

<header>
    <div class="header-btns">
        <button class="nav-btn" style="background:var(--danger)" onclick="clearAll()">CLEAR ALL</button>
        <button class="nav-btn" style="background:var(--blue)" onclick="exportJSON()">EXPORT JSON</button>
        <label style="background:var(--accent); padding:8px 12px; border-radius:4px; color:#000; font-size:0.65rem; font-weight:bold; cursor:pointer; text-transform: uppercase; min-width: 80px; text-align: center;">
            LOAD FILES <input type="file" id="pgnInput" accept="*" multiple hidden>
        </label>
    </div>
</header>

<div id="board-wrapper"><div id="board" style="width: 100%"></div></div>

<div class="controls">
    <div id="status-msg" style="text-align:center; font-weight:bold; margin-bottom:8px; font-size:0.8rem; color:var(--accent);">Ready</div>
    <div class="btn-group">
        <button style="background:#3c3a38" onclick="showHint()">Hint</button>
        <button style="background:#5c5a58" onclick="autoPlay()">Watch</button>
        <button style="background:#4583b6" onclick="solveMove()">Solve</button>
    </div>
    <button onclick="resetDrill()" style="width:100%; background:#444; margin-top:10px; padding:10px;">Reset Position</button>
</div>

<div class="library-section" id="repoList"></div>

<script>
    let board = null, game = new Chess(), repoData = [], currentPath = [], moveIndex = 0, currentIdx = -1;
    let selectedSquare = null;

    const sounds = {
        move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_standard_/default/move-self.mp3'),
        capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_standard_/default/capture.mp3')
    };

    function removeHighlights() {
        $('#board .square-55d63').removeClass('selected-square');
        $('.legal-dot').remove();
    }

    function onSquareClick(square) {
        if (currentIdx === -1) return;

        // 1. If we already have a selected square, try to move
        if (selectedSquare) {
            const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
            
            if (move) {
                // Check if it's the correct repertoire move
                if (move.san === currentPath[moveIndex]) {
                    processMove(move);
                    selectedSquare = null;
                    removeHighlights();
                    return;
                } else {
                    game.undo(); // Wrong move
                }
            }
        }

        // 2. Otherwise, select the new square if it contains a player's piece
        removeHighlights();
        const piece = game.get(square);
        
        if (piece && piece.color === 'w') {
            selectedSquare = square;
            $(`.square-${square}`).addClass('selected-square');
            
            // Show legal dots
            const moves = game.moves({ square: square, verbose: true });
            moves.forEach(m => {
                $(`.square-${m.to}`).append('<div class="legal-dot"></div>');
            });
        } else {
            selectedSquare = null;
        }
    }

    function processMove(move) {
        move.san.includes('x') ? sounds.capture.play() : sounds.move.play();
        moveIndex++;
        board.position(game.fen());
        
        if (moveIndex < currentPath.length) {
            setTimeout(() => {
                const reply = game.move(currentPath[moveIndex++]);
                board.position(game.fen());
                reply.san.includes('x') ? sounds.capture.play() : sounds.move.play();
                if (moveIndex === currentPath.length) document.getElementById('status-msg').innerText = "Line Complete!";
            }, 400);
        } else {
            document.getElementById('status-msg').innerText = "Line Complete!";
        }
    }

    window.onload = () => {
        const saved = localStorage.getItem('chess_reps_ultimate');
        if (saved) repoData = JSON.parse(saved);
        
        board = Chessboard('board', { 
            draggable: true,
            position: 'start', 
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
            onDragStart: (src) => { if(currentIdx === -1) return false; removeHighlights(); },
            onDrop: (src, tgt) => {
                const move = game.move({ from: src, to: tgt, promotion: 'q' });
                if (move && move.san === currentPath[moveIndex]) {
                    processMove(move);
                } else {
                    if (move) game.undo();
                    return 'snapback';
                }
            },
            onSnapEnd: () => { board.position(game.fen()); removeHighlights(); }
        });

        // MANUALLY ATTACH CLICK HANDLER TO SQUARES
        // This is the most reliable way for mobile
        $('#board').on('click', '.square-55d63', function() {
            const square = $(this).attr('data-square');
            onSquareClick(square);
        });

        renderSidebar();
        window.addEventListener('resize', () => board.resize());
    };

    // UI and Management Functions
    function showHint() {
        if (currentIdx === -1 || moveIndex >= currentPath.length) return;
        const tempGame = new Chess(game.fen());
        const moveObj = tempGame.move(currentPath[moveIndex]);
        if (moveObj) { $(`.square-${moveObj.from}, .square-${moveObj.to}`).addClass('hint-square'); }
    }

    function loadOpening(idx) {
        currentIdx = idx;
        game.reset();
        game.load_pgn(repoData[idx].raw.replace(/\[.*?\]/g, '').trim());
        currentPath = game.history();
        resetDrill();
        renderSidebar();
        document.getElementById('status-msg').innerText = repoData[idx].name;
    }

    function renameLine(e, idx) { e.stopPropagation(); const n = prompt("Rename:", repoData[idx].name); if (n) { repoData[idx].name = n; saveAndRender(); } }
    function deleteLine(e, idx) { e.stopPropagation(); if (confirm("Delete?")) { repoData.splice(idx, 1); if (currentIdx === idx) currentIdx = -1; saveAndRender(); } }
    function clearAll() { if (confirm("Wipe library?")) { repoData = []; currentIdx = -1; saveAndRender(); } }
    function exportJSON() {
        if (repoData.length === 0) return alert("Empty library!");
        const blob = new Blob([JSON.stringify(repoData, null, 2)], {type : 'application/json'});
        const dl = document.createElement('a');
        dl.href = URL.createObjectURL(blob);
        dl.download = "chess_reps_export.json";
        dl.click();
    }
    function saveAndRender() { localStorage.setItem('chess_reps_ultimate', JSON.stringify(repoData)); renderSidebar(); }

    document.getElementById('pgnInput').onchange = async (e) => {
        for (const file of e.target.files) {
            const text = await file.text();
            if (file.name.toLowerCase().endsWith('.json')) {
                const data = JSON.parse(text);
                repoData = repoData.concat(Array.isArray(data) ? data : [data]);
            } else {
                const games = text.split(/\[Event /g).filter(g => g.trim().length > 5).map(g => '[Event ' + g);
                repoData = repoData.concat(games.map(raw => ({
                    name: (raw.match(/\[Opening "(.*?)"\]/) || [null, "Line"])[1], raw: raw
                })));
            }
        }
        saveAndRender();
        e.target.value = '';
    };

    function renderSidebar() {
        document.getElementById('repoList').innerHTML = repoData.map((item, i) => `
            <div class="repo-item ${currentIdx==i?'active':''}" onclick="loadOpening(${i})">
                <span class="item-name">${item.name}</span>
                <div class="item-actions">
                    <button class="action-btn" onclick="renameLine(event, ${i})">‚úèÔ∏è</button>
                    <button class="action-btn" onclick="deleteLine(event, ${i})">üóëÔ∏è</button>
                </div>
            </div>`).join('');
    }

    function resetDrill() { game.reset(); board.start(); moveIndex = 0; selectedSquare = null; removeHighlights(); }
    function solveMove() { if (currentIdx !== -1 && moveIndex < currentPath.length) processMove(game.move(currentPath[moveIndex])); }
</script>
</body>
</html>
